<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>La Tribu</title>
    
    <!-- Archivo Central de Estilos (Aquí se cargan Bootstrap y los Iconos) -->
    <link href="css/main.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- IMPORTAMOS EL MOTOR DE LA BD PARA TENER LA URL DINÁMICA -->
    <script src="js/api_db.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        #app-content { 
            transition: opacity 0.15s ease-out; 
            padding-bottom: 0px; 
        }
        .fade-out { opacity: 0; }
        
        /* Espaciado dinámico para que la Navbar inferior no tape el contenido */
        .nav-padding {
            padding-bottom: 85px !important; 
        }
        
        .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }

        /* Botones globales de Atrás y Cerrar Sesión (Capa extrema superior) */
        .global-floating-btn {
            position: fixed;
            top: max(env(safe-area-inset-top, 20px), 20px);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex !important;
            align-items: center;
            justify-content: center;
            z-index: 999999 !important; 
            border: 1px solid rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        
        .global-floating-btn:active {
            transform: scale(0.9);
        }

        #global-back-btn { left: 15px; }
        #global-logout-btn { right: 15px; }

        /* Ocultar elementos globalmente de manera forzada cuando sea necesario */
        .hidden-forced { display: none !important; }

        /* Estilos para el botón de Pin (Fijar en barra) */
        .btn-pin {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #6c757d;
        }
        .btn-pin.active {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }
    </style>
</head>
<body class="bg-light m-0 p-0 overflow-hidden vh-100 d-flex flex-column">

    <!-- BOTÓN GLOBAL DE VOLVER ATRÁS -->
    <button id="global-back-btn" class="global-floating-btn hidden-forced" onclick="history.back()">
        <i class="bi bi-arrow-left fs-4 text-dark"></i>
    </button>

    <!-- BOTÓN GLOBAL DE CERRAR SESIÓN -->
    <button id="global-logout-btn" class="global-floating-btn hidden-forced" onclick="cerrarSesion()">
        <i class="bi bi-box-arrow-right fs-4 text-danger"></i>
    </button>

    <!-- Botón Flotante para Agregar Nuevo Acceso (Solo visible en Home) -->
    <button id="fab-add-acceso" class="btn btn-primary rounded-circle position-fixed shadow hidden-forced" 
            style="bottom: 90px; right: 20px; z-index: 1000; width: 60px; height: 60px;"
            data-bs-toggle="modal" data-bs-target="#modalNuevoAcceso">
        <i class="bi bi-plus text-white" style="font-size: 2rem; line-height: 1;"></i>
    </button>

    <!-- Contenedor Principal Dinámico (SPA) -->
    <main id="app-content" class="flex-grow-1 overflow-auto h-100 w-100 position-relative">
        <!-- El contenido de las vistas HTML se inyectará aquí -->
    </main>

    <!-- Barra de Navegación Inferior (Ahora es dinámica) -->
    <nav id="bottom-navigation" class="bottom-nav hidden-forced position-fixed bottom-0 w-100 d-flex justify-content-around align-items-center py-2">
        <!-- Se genera desde JavaScript mediante renderNavBar() -->
    </nav>

    <!-- Modal para Agregar Acceso Directo -->
    <div class="modal fade" id="modalNuevoAcceso" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Nuevo Acceso Directo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-nuevo-acceso">
                        <div class="mb-3">
                            <label class="form-label text-secondary small">Nombre de la Vista</label>
                            <input type="text" class="form-control rounded-3" id="acc-nombre" placeholder="Ej. Finanzas Personales" required>
                        </div>
                        
                        <!-- Carga de archivo HTML local -->
                        <div class="mb-3 p-3 bg-light rounded-3 border">
                            <label class="form-label text-primary fw-bold small mb-1"><i class="bi bi-cloud-upload"></i> Subir Archivo HTML (Opcional)</label>
                            <input type="file" class="form-control form-control-sm rounded-2" id="acc-file" accept=".html">
                            <div class="form-text" style="font-size: 0.75rem;">Si subes un archivo desde tu dispositivo, se guardará en la memoria interna de la app automáticamente.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-secondary small">Ruta Manual (Si el archivo ya existe en www/)</label>
                            <input type="text" class="form-control rounded-3" id="acc-ruta" placeholder="Ej. inventario">
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-secondary small">Icono</label>
                            <select class="form-select rounded-3" id="acc-icono">
                                <option value="bi-star-fill">Estrella</option>
                                <option value="bi-box-seam">Caja / Inventario</option>
                                <option value="bi-file-earmark-text">Documento</option>
                                <option value="bi-camera-fill">Cámara / Fotos</option>
                                <option value="bi-heart-fill">Corazón</option>
                                <option value="bi-lightning-fill">Rayo</option>
                                <option value="bi-gear-fill">Engranaje / Ajustes</option>
                                <option value="bi-graph-up-arrow">Gráfica / Finanzas</option>
                            </select>
                        </div>

                        <div class="form-check form-switch mb-4">
                            <input class="form-check-input" type="checkbox" id="acc-enbarra">
                            <label class="form-check-label text-secondary small" for="acc-enbarra">Fijar en barra de navegación inferior (Máx 3)</label>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 rounded-3 py-2 fw-bold">Guardar Acceso</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const cacheVistas = {};

        // === GESTIÓN UNIFICADA DE ACCESOS DIRECTOS ===
        const ACCESOS_POR_DEFECTO = [
            { nombre: 'Calendario', ruta: 'calendarioTribu', icono: 'bi-calendar-event', color: '#ff6b6b', enBarra: false },
            { nombre: 'Rutas / Gráficas', ruta: 'rutas', icono: 'bi-map-fill', color: '#20c997', enBarra: false },
            { nombre: 'Pagos JyK', ruta: 'tablapagosV1 (2)', icono: 'bi-cash-coin', color: '#ffc107', enBarra: false },
            { nombre: 'Apartados', ruta: 'apartados', icono: 'bi-shop', color: '#fd7e14', enBarra: false },
            { nombre: 'Usuarios', ruta: 'usuarios', icono: 'bi-people-fill', color: '#6f42c1', enBarra: false }
        ];

        function obtenerAccesos() {
            let guardados = localStorage.getItem('accesosTribu');
            if (guardados) {
                let accesos = JSON.parse(guardados);
                
                // Migración única
                if (!localStorage.getItem('limpiezaPinesV2')) {
                    accesos.forEach(acc => acc.enBarra = false);
                    localStorage.setItem('limpiezaPinesV2', 'completada');
                    localStorage.setItem('accesosTribu', JSON.stringify(accesos));
                }
                return accesos;
            } else {
                localStorage.setItem('limpiezaPinesV2', 'completada');
                localStorage.setItem('accesosTribu', JSON.stringify(ACCESOS_POR_DEFECTO));
                return ACCESOS_POR_DEFECTO;
            }
        }

        // --- FUNCIONES GLOBALES ---

        window.toggleBarra = function(event, index) {
            event.preventDefault();
            event.stopPropagation();
            
            let accesos = obtenerAccesos();
            let fijadosActuales = accesos.filter(a => a.enBarra).length;

            if (!accesos[index].enBarra && fijadosActuales >= 3) {
                alert('Solo puedes fijar un máximo de 3 accesos en la barra inferior.');
                return;
            }

            accesos[index].enBarra = !accesos[index].enBarra;
            localStorage.setItem('accesosTribu', JSON.stringify(accesos));
            
            renderHomeDashboard();
            renderNavBar();
        };

        window.eliminarAcceso = function(event, index) {
            event.preventDefault(); 
            event.stopPropagation();
            if (confirm('¿Deseas eliminar este acceso directo?')) {
                let accesos = obtenerAccesos();
                const ruta = accesos[index].ruta.replace('.html', '');
                
                accesos.splice(index, 1);
                localStorage.setItem('accesosTribu', JSON.stringify(accesos));
                localStorage.removeItem('vista_custom_' + ruta);
                
                renderHomeDashboard();
                renderNavBar();
            }
        };

        window.cerrarSesion = function() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                window.setLoginState(false);
                window.location.hash = 'login';
            }
        };

        window.setLoginState = function(isLoggedIn) {
            const nav = document.getElementById('bottom-navigation');
            if (isLoggedIn) {
                nav.classList.remove('hidden-forced');
            } else {
                nav.classList.add('hidden-forced');
                localStorage.removeItem('usuarioActual');
            }
        };

        function actualizarUIAuth() {
            const usuario = localStorage.getItem('usuarioActual');
            window.setLoginState(!!usuario);
        }

        // --- RENDERIZADO DE LA BARRA INFERIOR ---
        function renderNavBar() {
            const nav = document.getElementById('bottom-navigation');
            const accesosFijados = obtenerAccesos().filter(a => a.enBarra).slice(0, 3);
            
            let html = `
                <a href="#home" class="text-center text-decoration-none text-secondary flex-fill">
                    <i class="bi bi-house-door fs-4 d-block"></i>
                    <span style="font-size: 0.7rem;">Inicio</span>
                </a>
            `;
            
            accesosFijados.forEach(acc => {
                const hashLimpio = acc.ruta.replace('.html', '');
                html += `
                    <a href="#${hashLimpio}" class="text-center text-decoration-none text-secondary flex-fill">
                        <i class="bi ${acc.icono} fs-4 d-block" style="color: ${acc.color};"></i>
                        <span style="font-size: 0.7rem;">${acc.nombre}</span>
                    </a>
                `;
            });
            
            html += `
                <a href="#perfil" class="text-center text-decoration-none text-secondary flex-fill">
                    <i class="bi bi-person fs-4 d-block"></i>
                    <span style="font-size: 0.7rem;">Perfil</span>
                </a>
            `;
            
            nav.innerHTML = html;
        }

        // --- RENDERIZADO DEL DASHBOARD ---
        function renderHomeDashboard() {
            const contenedor = document.getElementById('app-content');
            let nombre = 'Tribu';
            try {
                const user = JSON.parse(localStorage.getItem('usuarioActual'));
                if (user && user.nombre) {
                    nombre = user.nombre.split(' ')[0];
                }
            } catch(e) {}

            const todosLosAccesos = obtenerAccesos();

            let gridHtml = '';
            todosLosAccesos.forEach((acc, index) => {
                const hashLimpio = acc.ruta.replace('.html', '');
                const bgColor = acc.color || '#0d6efd';
                
                let btnEliminar = `
                    <button onclick="eliminarAcceso(event, ${index})" class="btn btn-danger position-absolute shadow-sm" 
                            style="top: -8px; right: -8px; width: 28px; height: 28px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; z-index: 10;" title="Eliminar">
                        <i class="bi bi-x fs-5"></i>
                    </button>
                `;

                let btnPin = `
                    <button onclick="toggleBarra(event, ${index})" class="btn-pin ${acc.enBarra ? 'active' : ''} position-absolute shadow-sm" 
                            style="top: -8px; left: -8px; width: 28px; height: 28px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; z-index: 10;" title="Fijar en barra">
                        <i class="bi bi-pin-angle-fill fs-6"></i>
                    </button>
                `;

                gridHtml += `
                    <div class="col-6 col-md-4 position-relative">
                        ${btnPin}
                        ${btnEliminar}
                        <a href="#${hashLimpio}" class="text-decoration-none d-block h-100">
                            <div class="card border-0 shadow-sm h-100 rounded-4 text-center p-3" style="transition: transform 0.2s;">
                                <div class="d-flex justify-content-center align-items-center mx-auto rounded-circle mb-2" 
                                     style="width: 60px; height: 60px; background-color: ${bgColor}20; color: ${bgColor};">
                                    <i class="bi ${acc.icono}" style="font-size: 1.8rem;"></i>
                                </div>
                                <h6 class="text-dark fw-bold mb-0" style="font-size: 0.9rem;">${acc.nombre}</h6>
                            </div>
                        </a>
                    </div>
                `;
            });

            const html = `
                <div class="h-100 d-flex flex-column bg-light pb-safe">
                    <div class="position-relative w-100 flex-shrink-0 p-4 pt-5" style="background: linear-gradient(135deg, #0d6efd, #0dcaf0); border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;">
                        <div class="mt-3">
                            <h2 class="fw-bold text-white mb-0 mt-2">Hola, ${nombre}</h2>
                            <p class="text-white-50 mb-0">Tus accesos directos</p>
                        </div>
                    </div>
                    <div class="flex-grow-1 p-4 overflow-auto">
                        <div class="row g-3">
                            ${gridHtml}
                        </div>
                    </div>
                </div>
            `;

            contenedor.innerHTML = html;
            contenedor.classList.remove('fade-out');
        }

        async function cargarVista() {
            const contenedor = document.getElementById('app-content');
            const navBar = document.getElementById('bottom-navigation');
            const backBtn = document.getElementById('global-back-btn');
            const logoutBtn = document.getElementById('global-logout-btn');
            const fabBtn = document.getElementById('fab-add-acceso');
            
            let hash = window.location.hash.substring(1) || 'home';
            
            // Lógica de Autenticación
            const estaLogueado = !!localStorage.getItem('usuarioActual');
            if (!estaLogueado && hash !== 'login' && hash !== 'registro') {
                window.location.hash = 'login';
                return;
            }
            if (estaLogueado && (hash === 'login' || hash === 'registro')) {
                window.location.hash = 'home';
                return;
            }

            const vistasPrincipales = ['home', 'login', 'registro', 'perfil'];
            
            if (vistasPrincipales.includes(hash)) {
                backBtn.classList.add('hidden-forced'); 
                if (estaLogueado) {
                    navBar.classList.remove('hidden-forced'); 
                    contenedor.classList.add('nav-padding'); 
                }
            } else {
                backBtn.classList.remove('hidden-forced'); 
                navBar.classList.add('hidden-forced'); 
                contenedor.classList.remove('nav-padding'); 
            }

            if (estaLogueado && hash !== 'login' && hash !== 'registro') {
                logoutBtn.classList.remove('hidden-forced'); 
            } else {
                logoutBtn.classList.add('hidden-forced');
            }

            if (hash === 'home') {
                fabBtn.classList.remove('hidden-forced');
            } else {
                fabBtn.classList.add('hidden-forced');
            }

            contenedor.classList.add('fade-out');
            
            if (hash === 'home') {
                setTimeout(() => {
                    renderHomeDashboard();
                }, 150);
                return;
            }

            // --- Carga inteligente de la vista HTML ---
            try {
                let html = '';
                
                if (cacheVistas[hash]) {
                    html = cacheVistas[hash];
                } else {
                    const customHtmlGuardado = localStorage.getItem('vista_custom_' + hash);
                    
                    if (customHtmlGuardado) {
                        html = customHtmlGuardado;
                        cacheVistas[hash] = html;
                    } else {
                        const response = await fetch(`${hash}.html`);
                        if (!response.ok) throw new Error(`Vista no encontrada (${hash}.html)`);
                        html = await response.text();
                        cacheVistas[hash] = html; 
                    }
                }

                setTimeout(() => {
                    contenedor.innerHTML = html;
                    contenedor.classList.remove('fade-out');

                    // ==========================================
                    // MOTOR POTENCIADO DE EJECUCIÓN DE SCRIPTS
                    // ==========================================
                    const scripts = Array.from(contenedor.querySelectorAll('script'));
                    
                    const ejecutarScriptsSecuencialmente = async () => {
                        for (const script of scripts) {
                            await new Promise((resolve) => {
                                const nuevoScript = document.createElement('script');
                                
                                // Copiar atributos vitales (src, type, etc.)
                                Array.from(script.attributes).forEach(attr => {
                                    nuevoScript.setAttribute(attr.name, attr.value);
                                });

                                if (script.src) {
                                    // Esperar a que las librerías externas carguen
                                    nuevoScript.onload = resolve;
                                    nuevoScript.onerror = resolve; 
                                } else {
                                    // Ejecutar código interno al instante
                                    nuevoScript.text = script.innerHTML;
                                    resolve();
                                }
                                
                                document.body.appendChild(nuevoScript);
                                
                                // Limpiar el DOM sin romper ejecución
                                setTimeout(() => { 
                                    if(nuevoScript.parentNode) nuevoScript.parentNode.removeChild(nuevoScript); 
                                }, 100);
                            });
                        }
                        
                        // DESFIBRILADOR DE BOTONES Y EVENTOS
                        // Disparamos señales falsas de "Carga Terminada" para que las vistas subidas reaccionen
                        setTimeout(() => {
                            document.dispatchEvent(new Event('DOMContentLoaded'));
                            window.dispatchEvent(new Event('load'));
                        }, 50);
                    };

                    ejecutarScriptsSecuencialmente();

                }, 150); 

            } catch (error) {
                contenedor.innerHTML = `
                    <div class="h-100 d-flex flex-column align-items-center justify-content-center text-center p-4">
                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                        <h4 class="mt-3 text-secondary">Vista No Disponible</h4>
                        <p class="text-muted">No se pudo cargar: ${hash}.html<br>Puede que necesites volver a cargar el archivo local.</p>
                        <button class="btn btn-primary mt-3" onclick="history.back()">Volver</button>
                    </div>`;
                contenedor.classList.remove('fade-out');
            }
        }

        window.addEventListener('hashchange', cargarVista);
        
        window.addEventListener('DOMContentLoaded', () => {
            actualizarUIAuth();
            renderNavBar();
            cargarVista();
            
            const inputArchivo = document.getElementById('acc-file');
            const inputRuta = document.getElementById('acc-ruta');
            
            if (inputArchivo && inputRuta) {
                inputArchivo.addEventListener('change', function(e) {
                    if (this.files && this.files[0]) {
                        const nombreLimpio = this.files[0].name.replace('.html', '').replace(/\s+/g, '_');
                        inputRuta.value = nombreLimpio;
                    }
                });
            }

            const formNuevo = document.getElementById('form-nuevo-acceso');
            if(formNuevo) {
                formNuevo.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    let ruta = inputRuta.value.trim().replace('.html', '');
                    const archivoSeleccionado = inputArchivo.files[0];
                    const fijarEnBarra = document.getElementById('acc-enbarra').checked;
                    
                    if (!ruta) {
                        alert('Debes escribir una ruta o seleccionar un archivo HTML de tu dispositivo.');
                        return;
                    }

                    const nuevoAcceso = {
                        nombre: document.getElementById('acc-nombre').value,
                        ruta: ruta,
                        icono: document.getElementById('acc-icono').value,
                        color: '#0d6efd',
                        enBarra: fijarEnBarra
                    };

                    let accesos = obtenerAccesos();
                    let fijadosActuales = accesos.filter(a => a.enBarra).length;

                    if (fijarEnBarra && fijadosActuales >= 3) {
                        alert('Atención: Solo puedes fijar 3 accesos en la parte inferior. Se guardará, pero no se anclará.');
                        nuevoAcceso.enBarra = false;
                    }

                    const procesarGuardado = () => {
                        accesos.push(nuevoAcceso);
                        localStorage.setItem('accesosTribu', JSON.stringify(accesos));

                        const modalEl = document.getElementById('modalNuevoAcceso');
                        const modalIns = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                        modalIns.hide();
                        formNuevo.reset();

                        if (window.location.hash === '' || window.location.hash === '#home') {
                            renderHomeDashboard();
                        }
                        renderNavBar();
                    };

                    if (archivoSeleccionado) {
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            const htmlContent = evt.target.result;
                            localStorage.setItem('vista_custom_' + ruta, htmlContent);
                            procesarGuardado();
                        };
                        reader.readAsText(archivoSeleccionado);
                    } else {
                        procesarGuardado();
                    }
                });
            }

            if(window.location.hash === '' || window.location.hash === '#home') {
                fetch('login.html').then(r => r.text()).then(html => cacheVistas['login'] = html).catch(()=>{});
            }
        });
    </script>
</body>
</html>
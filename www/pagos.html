<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pagos JyK</title>
    <meta name="description" content="Aplicación para la gestión de pagos de caminatas nacionales.">
    <meta name="theme-color" content="#d4e1f5">
    
    <!-- Metadatos para Accesos Directos en iOS usando SVG interno (Sin CDNs) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestión Pagos">
    <link rel="apple-touch-icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23a2c4c9'/><text x='50%' y='50%' font-family='sans-serif' font-size='40' fill='%23ffffff' text-anchor='middle' dy='.3em'>JyK</text></svg>">
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23a2c4c9'/><text x='50%' y='50%' font-family='sans-serif' font-size='40' fill='%23ffffff' text-anchor='middle' dy='.3em'>JyK</text></svg>" type="image/svg+xml">

    <!-- Estilos CSS Integrados -->
    <style>
        /* -------------------
         * Variables y Reseteo General (Solo Claro y Oscuro)
         * ------------------- */
        :root, .theme-light {
            --color-primario: #a2c4c9;
            --color-secundario: #d4e1f5;
            --color-fondo: #f0f4f8;
            --color-texto: #333333;
            --color-acento: #f5b9a2;
            --color-exito: #a2d5ab;
            --color-error: #f5a2a2;
            --color-blanco: #ffffff;
            --sombra-suave: 0 4px 8px rgba(0, 0, 0, 0.1);
            --borde-radio: 12px;
        }

        .theme-dark {
            --color-primario: #607d8b;
            --color-secundario: #37474f;
            --color-fondo: #1e272c;
            --color-texto: #eceff1;
            --color-acento: #ffab40;
            --color-exito: #81c784;
            --color-error: #e57373;
            --color-blanco: #263238;
        }

        /* Reseteo y Estilos Base */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
        body { background-color: var(--color-fondo); color: var(--color-texto); transition: background-color 0.3s, color 0.3s; line-height: 1.6; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* -------------------
         * Contenedores y Layout
         * ------------------- */
        .container{max-width:1200px;margin:20px auto;padding:20px}
        .content-section{background-color:var(--color-blanco);padding:1.5rem;border-radius:var(--borde-radio);margin-bottom:1.5rem; box-shadow: var(--sombra-suave);}
        .section-header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--color-secundario);padding-bottom:1rem;margin-bottom:1rem;flex-wrap:wrap}
        .section-title { color: var(--color-primario); margin: 0; }
        
        .item-card{border:1px solid var(--color-secundario);border-radius:var(--borde-radio);padding:1rem;padding-top:50px;margin-top:1rem;display:grid;grid-template-columns:1fr;gap:1rem;position:relative}
        .card-top-row{display:grid;gap:1rem;grid-template-columns:1fr}
        @media (min-width: 768px) { .card-top-row { grid-template-columns: repeat(3, 1fr); } }
        
        .price-details-container{display:flex;flex-direction:column;gap:1rem}
        @media (min-width: 768px) { .price-details-container { flex-direction: row; align-items: center; } }

        .total-display{display:flex;justify-content:space-between;align-items:center;font-weight:bold;color:var(--color-exito);margin-bottom:1rem}
        .grupal-total-formula { font-weight: bold; color: var(--color-acento); }
        @media (min-width: 768px) { .total-display, .grupal-total-formula { padding-bottom: 0.8rem; } }

        /* -------------------
         * Formularios y Botones
         * ------------------- */
        .form-group{margin-bottom:1.5rem;position:relative}.form-group label{display:block;margin-bottom:.5rem;font-weight:600}.form-group input,.form-group select,.form-group textarea{width:100%;padding:.8rem;border:1px solid var(--color-secundario);border-radius:8px;background-color:var(--color-fondo);color:var(--color-texto);transition:border-color .3s}.form-group textarea{resize:vertical;min-height:80px}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--color-acento)}
        
        .btn{padding:.8rem 1.2rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;margin-top:.5rem}.btn-primary{background-color:var(--color-primario);color:var(--color-blanco)}.btn-secondary{background-color:var(--color-secundario);color:var(--color-texto)}.btn-exito{background-color:var(--color-exito);color:var(--color-blanco)}.btn-error{background-color:var(--color-error);color:var(--color-blanco)}.btn-success{background-color:#25D366;color:var(--color-blanco)}
        .btn-add-item{background-color:var(--color-exito);color:var(--color-blanco);border:none;width:40px;height:40px;border-radius:50%;font-size:24px;cursor:pointer;flex-shrink:0;transition:background-color .3s,transform .2s}
        .btn-add-item:hover { background-color: #82c98d; transform: scale(1.1); }
        .btn-delete-item{position:absolute;top:10px;right:10px;background-color:var(--color-error);color:white;border:none;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background-color .2s,transform .2s}
        .btn-delete-item:hover { background-color: #d32f2f; transform: scale(1.1); }
        .btn-delete-item svg { fill: white; width: 18px; height: 18px; }
        .btn-delete-field{position:absolute;top:0;right:0;background:none;border:none;cursor:pointer;padding:5px;opacity:.6;transition:opacity .2s}
        .btn-delete-field:hover { opacity: 1; }
        .btn-delete-field svg { width: 16px; height: 16px; fill: var(--color-error); }
        .btn-collapse-item{position:absolute;top:8px;left:10px;background-color:var(--color-secundario);color:var(--color-texto);border:none;border-radius:8px;width:auto;padding:6px 10px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background-color .2s,transform .2s;font-size:.8rem}
        .btn-collapse-item:hover { background-color: var(--color-primario); transform: scale(1.05); }

        /* -------------------
         * Pestañas y Navegación
         * ------------------- */
        .tabs{display:flex;margin-bottom:1.5rem;border-bottom:2px solid var(--color-secundario)}.tab-link{padding:1rem 1.5rem;cursor:pointer;font-weight:600;border:none;background:none;color:var(--color-texto);border-bottom:3px solid transparent}.tab-link.active{color:var(--color-acento);border-bottom-color:var(--color-acento)}.tab-content{display:none;animation:fadeIn .5s}.tab-content.active{display:block}@keyframes fadeIn{from{opacity:0}to{opacity:1}}

        /* -------------------
         * Modales y UI Extras
         * ------------------- */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center;z-index:2000;visibility:hidden;opacity:0;transition:visibility 0s .3s,opacity .3s}.modal-overlay.visible{visibility:visible;opacity:1;transition:visibility 0s,opacity .3s}.modal-content{background-color:var(--color-blanco);padding:2rem;border-radius:var(--borde-radio);width:90%;max-width:500px;text-align:center;transform:scale(.9);transition:transform .3s}.modal-overlay.visible .modal-content{transform:scale(1)}.modal-content h3{margin-bottom:1rem}.modal-content p{margin-bottom:1.5rem}.modal-buttons{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap}.modal-btn{padding:.7rem 1.5rem;border:none;border-radius:8px;font-weight:600;cursor:pointer}.btn-accept{background-color:var(--color-primario);color:var(--color-blanco)}.btn-confirm{background-color:var(--color-error);color:#fff}.btn-cancel{background-color:var(--color-secundario);color:var(--color-texto)}
        
        /* Estilos para colapsar */
        .item-card .collapsible-content { display: block; }
        .item-card.collapsed .collapsible-content { display: none; }
        .collapsed-summary { display: none; }
        .item-card.collapsed .collapsed-summary { display: flex; flex-direction: column; align-items: center; padding: 0; }
        .collapsed-summary h4 { color: var(--color-primario); font-size: 1.1rem; margin-top: 0.5rem; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 45px; }
        .collapsed-summary .total-display { text-align: center; width: 100%; }
        
        #tipo-cambio-wrapper { display: none; }
        .crc-conversion { display: none; text-align: right; color: var(--color-texto); margin-top: -0.75rem; margin-bottom: 1rem; }

        /* Estilos de Eventos Guardados */
        #eventos-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            align-items: center;
        }
        #search-eventos {
            flex-grow: 1;
            padding: 0.8rem;
            border: 2px solid var(--color-primario);
            border-radius: 8px;
            background-color: var(--color-fondo);
        }
        #toggle-eventos-list {
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 8px;
            background-color: var(--color-secundario);
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

        #eventos-guardados-wrapper {
            display: none;
            margin-top: 1rem;
        }

        #eventos-guardados-list { display: flex; flex-wrap: wrap; gap: 1rem; }
        .evento-guardado-btn { background-color: var(--color-blanco); border: 1px solid var(--color-secundario); padding: 1rem; border-radius: var(--borde-radio); cursor: pointer; text-align: left; flex-grow: 1; display: flex; justify-content: space-between; align-items: center; }
        .evento-guardado-btn:hover { border-color: var(--color-primario); background-color: var(--color-secundario); }
        .evento-guardado-btn div { display: flex; flex-direction: column; }
        .evento-guardado-btn strong { color: var(--color-primario); }
        .evento-guardado-btn small { color: var(--color-exito); font-weight: bold; }
        .btn-delete-evento{background-color:var(--color-error);color:white;border:none;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;margin-left:1rem}
        .btn-delete-evento:hover{background-color:#d32f2f}
        .btn-delete-evento svg{width:14px;height:14px;fill:white}
        .btn-factura-evento{background-color:var(--color-acento);color:white;border:none;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;margin-left:.5rem}
        .btn-factura-evento:hover{background-color:var(--color-texto)}
        .btn-factura-evento svg{width:14px;height:14px;fill:white}

        /* -------------------
         * Botones Flotantes (FAB)
         * ------------------- */
        .fab{position:fixed;bottom:25px;width:60px;height:60px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;box-shadow:var(--sombra-suave);cursor:pointer;z-index:1000;transition:transform .2s ease-in-out,background-color .3s}.fab:hover{transform:scale(1.08)}.fab svg{width:28px;height:28px;fill:var(--color-blanco)}.fab-left{left:25px;background-color:var(--color-acento)}.fab-right{right:25px;background-color:var(--color-exito)}

        .text-danger {
            color: var(--color-error) !important;
            font-weight: bold;
        }
        
        #settings-modal .modal-content, #tab-configuracion .content-section, #report-section pre {
            text-align: left;
        }
        #settings-modal h3, #settings-modal h4, #tab-configuracion h3, #tab-configuracion h4 {
            text-align: center;
            margin-bottom: 1rem;
        }
        .settings-section {
            border-top: 1px solid var(--color-secundario);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        #autosave-timer {
            background-color: var(--color-fondo);
            padding: 0.8rem;
            border-radius: var(--borde-radio);
            text-align: center;
            font-weight: bold;
            color: var(--color-primario);
        }

        #theme-selector {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        /* Estilos específicos para la impresión del PDF */
        @media print {
            body { background-color: #ffffff; color: #000000; }
            .container { max-width: none; margin: 0; padding: 0; }
            .content-section, .item-card { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; }
            .header, .tabs, .fab, .btn, .modal-overlay, .tab-content, #eventos-search-container { display: none; }
            .content-section { padding: 1rem; margin-bottom: 1rem; }
            #report-section { border: none; background-color: transparent; padding: 0; max-height: none; overflow-y: visible; }
        }

        /* Estilos responsivos para factura en móvil */
        @media (max-width: 768px) {
            #factura-print-content .factura-table { display: none; }
            #factura-print-content .factura-mobile-list { display: block !important; }
            #factura-print-content .factura-mobile-item { border: 1px solid var(--color-secundario); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--color-fondo); }
            #factura-print-content .factura-mobile-header { font-weight: bold; color: var(--color-primario); margin-bottom: 0.5rem; font-size: 1.1rem; }
            #factura-print-content .factura-mobile-details { display: flex; flex-direction: column; gap: 0.25rem; }
            #factura-print-content .factura-mobile-detail { display: flex; justify-content: space-between; font-size: 0.9rem; }
            #factura-print-content .factura-mobile-detail strong { color: var(--color-texto); }
            #factura-print-content .factura-mobile-total { text-align: right; font-weight: bold; color: var(--color-exito); font-size: 1.1rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--color-secundario); }
        }
        
        @media (min-width: 769px) {
            #factura-print-content .factura-mobile-list { display: none !important; }
        }

        /* -------------------
         * Responsividad
         * ------------------- */
        @media (max-width: 768px) {
            body { padding-bottom: 80px; }
            .container { margin: 10px auto; padding: 10px; }
            .tabs { font-size: 0.9rem; flex-wrap: wrap; }
            .tab-link { padding: 0.8rem 1rem; }
            .section-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .section-header .form-group { width: 50%; margin-top: 0.5rem; margin-bottom: 0; }
            .fab { width: 50px; height: 50px; bottom: 15px; }
            .fab-left { left: 15px; }
            .fab-right { right: 15px; }
            #eventos-search-container { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body class="theme-light"><div id="app-container" class="container"><div class="tabs"><button class="tab-link active" data-tab="nacionales">TABLA DE PAGOS</button><button class="tab-link" data-tab="configuracion">CONFIGURACIÓN</button></div><div id="tab-nacionales" class="tab-content active"><div class="content-section"><div class="section-header"><h3 class="section-title">Eventos Guardados</h3><button id="nuevo-evento-btn" class="btn btn-primary">Nuevo Evento</button></div>
<div id="eventos-search-container"><input type="text" id="search-eventos" placeholder="Buscar por nombre o precio..."><button id="toggle-eventos-list">Mostrar Lista</button></div><div id="eventos-guardados-wrapper"><div id="eventos-guardados-list"></div></div>
</div>

            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Información General del Evento</h3>
                    <div class="form-group">
                        <label for="currency-selector" style="display:none;">Moneda</label>
                        <select id="currency-selector">
                            <option value="CRC">CRC (₡)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label for="evento-nombre">Nombre del Evento</label>
                        <input type="text" id="evento-nombre">
                    </div>
                     <div class="form-group">
                        <label for="evento-precio">Precio del Evento</label>
                        <input type="number" id="evento-precio" value="0" min="0">
                    </div>
                     <div class="form-group">
                        <label for="evento-capacidad-cg">Capacidad C/G</label>
                        <input type="number" id="evento-capacidad-cg" value="0" min="0">
                    </div>
                     <div class="form-group">
                        <label for="evento-capacidad-sg">Capacidad S/G</label>
                        <input type="number" id="evento-capacidad-sg" value="0" min="0">
                    </div>
                    <div class="form-group" id="tipo-cambio-wrapper">
                        <label for="tipo-cambio">Tipo de Cambio</label>
                        <input type="number" id="tipo-cambio" value="500" min="1">
                    </div>
                    <div class="form-group" id="total-conversion-container">
                        <label id="total-conversion-label">Total en USD</label>
                        <p id="total-conversion" style="font-weight: bold; font-size: 1.2rem; color: var(--color-primario); margin-top: 8px;">$0</p>
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Lista de Pagos</h3>
                    <button class="btn-add-item" data-category="transporte-nacional">+</button>
                </div>
                <div id="transporte-nacional-list"></div>
            </div>

            <div class="content-section">
                <h3 class="section-title">Totales</h3>
                
                <div class="total-display">
                    <strong>Total a Recoger:</strong> 
                    <span id="total-por-recoger">0</span>
                </div>
                <div class="crc-conversion" id="total-por-recoger-crc-wrapper">
                    <small>Total a Recoger CRC: <span id="total-por-recoger-crc">0</span></small>
                </div>
                
                <div class="total-display">
                    <strong>TOTALES POR PERSONA:</strong> 
                    <span id="grand-total-nacionales">0</span>
                </div>
                <div class="crc-conversion" id="grand-total-nacionales-crc-wrapper">
                    <small>TOTAL POR PERSONA CRC: <span id="grand-total-nacionales-crc">0</span></small>
                </div>

                <div class="total-display">
                    <strong>excedente P.P:</strong> 
                    <span id="diferencia-nacionales">0</span>
                </div>
                 <div class="crc-conversion" id="diferencia-nacionales-crc-wrapper">
                    <small>excedente P.P CRC: <span id="diferencia-nacionales-crc">0</span></small>
                </div>

                <div class="total-display">
                    <strong>excedente general:</strong> 
                    <span id="diferencia-general-nacionales">0</span>
                </div>
                <div class="crc-conversion" id="diferencia-general-nacionales-crc-wrapper">
                    <small>excedente general CRC: <span id="diferencia-general-nacionales-crc">0</span></small>
                </div>
            </div>
        </div>

                
        <!-- Contenido de Configuración -->
        <div id="tab-configuracion" class="tab-content">
            <div class="content-section">
                <h3>CONFIGURACIÓN GENERAL</h3>
            
                <div class="settings-section">
                    <h4>Respaldo y Restauración de Eventos</h4>
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
                        <button id="backup-btn" class="btn btn-primary">Respaldar Eventos</button>
                        <button onclick="document.getElementById('restore-input').click();" class="btn btn-secondary">Restaurar Eventos</button>
                        <input type="file" id="restore-input" accept=".json" style="display: none;">
                    </div>
                    <h4>Autoguardado</h4>
                    <p style="text-align: center;">Próximo respaldo automático en:</p>
                    <div id="autosave-timer">Calculando...</div>
                </div>

                <div class="settings-section">
                    <h4>Tema de la Aplicación</h4>
                    <!-- Selector Reducido a Claro y Oscuro -->
                    <div id="theme-selector">
                        <button id="btn-theme-light" class="btn btn-secondary">Modo Claro</button>
                        <button id="btn-theme-dark" class="btn btn-primary">Modo Oscuro</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Botones Flotantes -->
    <button id="add-pago-fab" class="fab fab-left" aria-label="Agregar Nuevo Pago">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>
    <button id="guardar-evento-btn" class="fab fab-right" aria-label="Guardar Evento">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
    </button>
    
    <!-- Modales -->
    <div id="notification-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="notification-title">Notificación</h3>
            <p id="notification-message"></p>
            <div class="modal-buttons">
                <button id="notification-accept-btn" class="modal-btn btn-accept">Aceptar</button>
            </div>
        </div>
    </div>
    
    <div id="loss-warning-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="loss-warning-title" style="color: var(--color-error);">¡Advertencia!</h3>
            <p id="loss-warning-message">Está teniendo pérdida.</p>
            <div class="modal-buttons">
                <button id="loss-warning-close-btn" class="modal-btn btn-cancel">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="delete-confirm-title">Confirmar Borrado</h3>
            <p id="delete-confirm-message">¿Estás seguro de que deseas borrar este elemento?</p>
            <div class="modal-buttons">
                <button id="delete-confirm-btn" class="modal-btn btn-confirm">Sí, borrar</button>
                <button id="delete-cancel-btn" class="modal-btn btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="edit-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="edit-confirm-title">Confirmar Edición</h3>
            <p id="edit-confirm-message">¿Estás seguro?</p>
            <div class="modal-buttons">
                <button id="edit-confirm-btn" class="modal-btn btn-confirm">Sí, editar</button>
                <button id="edit-cancel-btn" class="modal-btn btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="factura-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid var(--color-secundario); padding-bottom: 1rem;">
                <h3 id="factura-title" style="margin: 0; color: var(--color-primario);">FACTURA</h3>
                <button id="factura-close-btn" class="modal-btn btn-cancel" style="padding: 0.5rem 1rem;">Cerrar</button>
            </div>
            <div id="factura-content"></div>
            <div style="margin-top: 2rem; text-align: center;">
                <button id="factura-print-btn" class="btn btn-primary" style="margin-right: 1rem;">Imprimir</button>
                <button id="factura-pdf-btn" class="btn btn-secondary" style="margin-right: 1rem;">Descargar Imagen</button>
                <button id="factura-whatsapp-btn" class="btn btn-success">Compartir WhatsApp</button>
            </div>
        </div>
    </div>

    <div id="add-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="add-confirm-title">Confirmar Nuevo Pago</h3>
            <p id="add-confirm-message">¿Estás seguro de que deseas agregar un nuevo pago?</p>
            <div class="modal-buttons">
                <button id="add-confirm-btn" class="modal-btn btn-exito">Sí, agregar</button>
                <button id="add-cancel-btn" class="modal-btn btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const DB_NAME = 'PagosAppDB';
        const DB_VERSION = 2;
        let db;
        let currentCurrency = 'CRC';
        let currentEventId = null;
        let editConfirmCount = 0;
        let eventToLoadId = null;
        const AUTOSAVE_INTERVAL = 4*24*60*60*1000;
        let allEventsCache = [];

        const airlinesData = {
            "Arajet": "hablemos@arajet.com", "AeroMexico": "Call Center: 2440-1354 / 2440-1378, Web: www.aeromexico.com", "Air Canada": "Call Center: 0800-032-0066, Web: www.aircanada.com", "Air Transat": "Web: http://www.airtransat.com", "AirFrance": "Call Center: 2539-7413, Web: www.airfrance.cr", "Alaska": "Call Center: 1-800-252-7522, Web: www.alaskaair.com", "American Airlines": "Call Center: 2420-1217, Web: www.aa.com", "Avianca": "Call Center: 4002-3320, Web: www.avianca.com", "British Airlines": "Call Center: 2441-2537, Web: www.britishairways.com", "Costa Rica Green Airways": "Call Center: 4070-0771, Web: www.costaricagreenair.com", "Copa Airlines": "Call Center: 800-044-0005, Web: www.copa.com", "Delta Airlines": "Call Center: 2257-4141, Web: www.delta.com", "Frontier": "Call Center: 2435-9262, Web: www.flyfrontier.com", "GOL": "Call Center: +55 11 3471 2973, Web: www.voegol.com.br", "Edelweiss": "Call Center: 1-877-359-7947, Web: www.flyedelweiss.com", "Iberojet": "Call Center: 6414-1180, Web: www.iberojet.com", "Iberia": "Call Center: 2036-0069, Web: www.iberia.com", "LATAM": "Call Center: 2257-5745, Web: www.latamairlines.com", "Lufthansa": "Call Center: 2442-7502, Web: www.lufthansa.com", "KLM": "Call Center: 2430-4748, Web: www.klm.com", "jetBlue": "Call Center: 0-800-012-1666, Web: www.jetblue.com", "SANSA": "Call Center: 2290-4100, Web: www.flysansa.com", "Southwest": "Call Center: 0-800-012-1917, Web: www.espanol.southwest.com", "Spirit": "Call Center: 4000-1887, Web: www.spirit.com", "United": "Call Center: 0-800-044-0005, Web: www.united.com", "Volaris": "Call Center: 4002-7462, Web: www.volaris.com", "Wingo": "Call Center: 0-571-307-8133, Web: www.wingo.com"
        };

        const tabs = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const addItemBtns = document.querySelectorAll('.btn-add-item');
        const eventoNombre = document.getElementById('evento-nombre');
        const eventoPrecio = document.getElementById('evento-precio');
        const eventoCapacidadCG = document.getElementById('evento-capacidad-cg');
        const eventoCapacidadSG = document.getElementById('evento-capacidad-sg');
        const tipoCambioInput = document.getElementById('tipo-cambio');
        const tipoCambioWrapper = document.getElementById('tipo-cambio-wrapper');
        const totalConversionLabel = document.getElementById('total-conversion-label');
        const totalConversionDisplay = document.getElementById('total-conversion');
        const totalConversionContainer = document.getElementById('total-conversion-container');
        const currencySelector = document.getElementById('currency-selector');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');
        const editConfirmModal = document.getElementById('edit-confirm-modal');
        const editConfirmBtn = document.getElementById('edit-confirm-btn');
        const editCancelBtn = document.getElementById('edit-cancel-btn');
        const editConfirmMessage = document.getElementById('edit-confirm-message');
        const addConfirmModal = document.getElementById('add-confirm-modal');
        const addConfirmBtn = document.getElementById('add-confirm-btn');
        const addCancelBtn = document.getElementById('add-cancel-btn');
        const facturaModal = document.getElementById('factura-modal');
        const facturaCloseBtn = document.getElementById('factura-close-btn');
        const facturaTitle = document.getElementById('factura-title');
        const facturaContent = document.getElementById('factura-content');
        const facturaPrintBtn = document.getElementById('factura-print-btn');
        const facturaPdfBtn = document.getElementById('factura-pdf-btn');
        const facturaWhatsappBtn = document.getElementById('factura-whatsapp-btn');
        const grandTotalNacionalesCrc = document.getElementById('grand-total-nacionales-crc');
        const diferenciaNacionalesCrc = document.getElementById('diferencia-nacionales-crc');
        const diferenciaGeneralNacionalesCrc = document.getElementById('diferencia-general-nacionales-crc');
        const crcConversionWrappers = document.querySelectorAll('.crc-conversion');
        const guardarEventoBtn = document.getElementById('guardar-evento-btn');
        const nuevoEventoBtn = document.getElementById('nuevo-evento-btn');
        const eventosGuardadosList = document.getElementById('eventos-guardados-list');
        const lossWarningModal = document.getElementById('loss-warning-modal');
        const lossWarningCloseBtn = document.getElementById('loss-warning-close-btn');
        const backupBtn = document.getElementById('backup-btn');
        const autosaveTimerDisplay = document.getElementById('autosave-timer');
        const addPagoFab = document.getElementById('add-pago-fab');
        
        const searchInput = document.getElementById('search-eventos');
        const toggleEventosListBtn = document.getElementById('toggle-eventos-list');
        const eventosGuardadosWrapper = document.getElementById('eventos-guardados-wrapper');

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => { console.error('Error al abrir IndexedDB:', event.target.error); reject('Error de base de datos'); };
                request.onsuccess = (event) => { 
                    db = event.target.result;
                    console.log('Base de datos abierta exitosamente.'); 
                    resolve(); 
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('eventos')) { 
                        db.createObjectStore('eventos', { keyPath: 'id', autoIncrement: true }); 
                    }
                };
            });
        }

        document.body.addEventListener('keydown', (e) => {
            const isNumericField = e.target.type === 'number' || e.target.classList.contains('item-price-per-person') || e.target.classList.contains('item-price-grupal') || e.target.classList.contains('item-quantity') || e.target.classList.contains('airline-price') || e.target.id === 'evento-precio' || e.target.id === 'evento-capacidad-cg' || e.target.id === 'evento-capacidad-sg' || e.target.id === 'tipo-cambio' || e.target.id.startsWith('monto-');
            
            if (isNumericField) {
                if (!/[0-9]/.test(e.key) && e.key !== '.' && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') {
                    if (!(e.ctrlKey || e.metaKey) || (e.key !== 'a' && e.key !== 'c' && e.key !== 'v' && e.key !== 'x')) {
                        e.preventDefault();
                    }
                }
            }
        });

        document.body.addEventListener('input', (e) => {
            if (e.target.type === 'number' || e.target.classList.contains('item-price-per-person') || e.target.classList.contains('item-price-grupal') || e.target.classList.contains('item-quantity') || e.target.classList.contains('airline-price') || e.target.id === 'evento-precio' || e.target.id === 'evento-capacidad-cg' || e.target.id === 'evento-capacidad-sg' || e.target.id === 'tipo-cambio' || e.target.id.startsWith('monto-')) {
                let value = e.target.value.replace(/[^0-9.]/g, ''); 
                if (value.length > 1 && value.startsWith('0') && !value.startsWith('0.')) {
                    value = parseFloat(value);
                }
                e.target.value = value;
            }
            if (e.target === eventoNombre || e.target.classList.contains('item-nombre')) {
                e.target.value = e.target.value.toUpperCase();
            }

            if (e.target.matches('.phone-input')) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            }
        });

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                const targetTab = document.getElementById(`tab-${tab.dataset.tab}`);
                if(targetTab) targetTab.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                if(targetTab) targetTab.classList.add('active');
            });
        });
        
        function updateFieldSelectorsForCurrency() {
            const allFieldSelectors = document.querySelectorAll('.field-selector');
            allFieldSelectors.forEach(selector => {
                const airlineOption = selector.querySelector('option[value="aerolinea"]');
                const card = selector.closest('.item-card');
                if (currentCurrency === 'USD') {
                    if (!airlineOption) {
                        const option = document.createElement('option');
                        option.value = 'aerolinea';
                        option.textContent = 'Aerolínea';
                        selector.options[0].insertAdjacentElement('afterend', option);
                    }
                } else { 
                    if (airlineOption) {
                        airlineOption.remove();
                    }
                    const airlineField = card.querySelector('[data-field-name="aerolinea"]');
                    if (airlineField) {
                        airlineField.remove();
                        togglePriceVisibility(card);
                    }
                }
            });
        }
        
        currencySelector.addEventListener('change', (e) => {
            currentCurrency = e.target.value;
            tipoCambioWrapper.style.display = (currentCurrency === 'USD') ? 'block' : 'none';
            totalConversionContainer.style.display = (currentCurrency === 'USD') ? 'block' : 'none';
            totalConversionLabel.textContent = (currentCurrency === 'USD') ? 'Total en CRC' : 'Total en USD';
            
            updateFieldSelectorsForCurrency();
            updateAllTotals();
        });

        function togglePriceVisibility(card) {
            if (!card) return;
            const airlineField = card.querySelector('[data-field-name="aerolinea"]');
            const pricePerPersonInput = card.querySelector('.item-price-per-person');
            if (pricePerPersonInput) {
                const priceGroup = pricePerPersonInput.closest('.form-group');
                if (priceGroup) {
                    priceGroup.style.display = airlineField ? 'none' : 'block';
                }
            }
        }

        function addNewPagoItem() {
            openAddModal(() => {
                const category = 'transporte-nacional';
                const listContainer = document.getElementById(`${category}-list`);
                if (listContainer) {
                    const lastItem = listContainer.lastElementChild;
                    if (lastItem) {
                        const nombreInput = lastItem.querySelector('input[required]');
                        if (nombreInput && nombreInput.value.trim() === '') {
                            showNotification('Por favor, completa el campo "Nombre" del último pago antes de agregar uno nuevo.');
                            return;
                        }
                    }

                    const itemsToCollapse = listContainer.querySelectorAll('.item-card');
                    itemsToCollapse.forEach(card => {
                        if (!card.classList.contains('collapsed')) {
                            card.classList.add('collapsed');
                            const collapseBtn = card.querySelector('.btn-collapse-item');
                            if (collapseBtn) collapseBtn.textContent = 'Mostrar';
                        }
                    });

                    const newItemWrapper = document.createElement('div');
                    newItemWrapper.innerHTML = createItemHTML();
                    const newItem = newItemWrapper.firstElementChild;
                    listContainer.appendChild(newItem);
                    calculateGrandTotal(category);
                    newItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }

        addItemBtns.forEach(btn => {
            btn.addEventListener('click', addNewPagoItem);
        });

        if (addPagoFab) {
            addPagoFab.addEventListener('click', addNewPagoItem);
        }

        document.body.addEventListener('click', (e) => {
            const collapseBtn = e.target.closest('.btn-collapse-item');
            const deleteFieldBtn = e.target.closest('.btn-delete-field');
            const exportPagoBtn = e.target.closest('.export-pago-btn');

            if (collapseBtn) {
                const card = collapseBtn.closest('.item-card');
                if (card) {
                    card.classList.toggle('collapsed');
                    const isCollapsed = card.classList.contains('collapsed');
                    collapseBtn.textContent = isCollapsed ? 'Mostrar' : 'Ocultar';
                    if (isCollapsed) {
                        updateTotals(card.querySelector('input')); 
                    }
                }
            }
            if (deleteFieldBtn) {
                const formGroup = deleteFieldBtn.closest('.form-group');
                if (formGroup) {
                    const fieldName = formGroup.dataset.fieldName;
                    const itemCard = formGroup.closest('.item-card');
                    if (itemCard) {
                        if (fieldName) {
                            const selector = itemCard.querySelector('.field-selector');
                            const option = selector.querySelector(`option[value="${fieldName}"]`);
                            if (option) option.disabled = false;
                        }
                        formGroup.remove();
                        if (fieldName === 'aerolinea') {
                            togglePriceVisibility(itemCard);
                        }
                        updateTotals(itemCard.querySelector('input')); 
                    }
                }
            }
            if (exportPagoBtn) {
                const card = exportPagoBtn.closest('.item-card');
                if (card) {
                    const pagoData = getPagoDataFromCard(card);
                    const jsonString = JSON.stringify(pagoData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const nombrePago = (pagoData.nombre || 'pago').replace(/\s+/g, '_');
                    a.download = `pago_${nombrePago}_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }
        });

        function createItemHTML() {
            const uniqueId = `item-${Date.now()}-${Math.random()}`;
            let airlineOptionHTML = (currentCurrency === 'USD') ? `<option value="aerolinea">Aerolínea</option>` : '';
            
            return `<div class="item-card" id="${uniqueId}"><button class="btn-collapse-item" aria-label="Colapsar pago">Ocultar</button><button class="btn-delete-item" aria-label="Eliminar pago"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button><div class="collapsed-summary"></div><div class="collapsible-content"><div class="card-top-row"><div class="form-group"><label for="nombre-${uniqueId}">Nombre</label><input type="text" id="nombre-${uniqueId}" class="item-nombre" required></div><div class="form-group"><label for="tipo-precio-${uniqueId}">Tipo de Precio</label><select id="tipo-precio-${uniqueId}" class="price-type-selector"><option value="persona">Precio por Persona</option><option value="grupal">Precio Grupal</option></select></div><div class="form-group"><label for="field-selector-${uniqueId}">Añadir Campo</label><select id="field-selector-${uniqueId}" class="field-selector" data-card-id="${uniqueId}"><option value="">Seleccionar...</option>${airlineOptionHTML}<option value="descripcion">Descripción</option><option value="telefono">Teléfono</option><option value="whatsapp">WhatsApp</option><option value="email">Email</option><option value="fecha">Fecha</option><option value="cantidad">Cantidad</option><option value="tipo_pago">Tipo de Pago</option><option value="guias">Guías</option><option value="nombre_encargado">Nombre Encargado</option><option value="telefono_encargado">Teléfono Encargado</option><option value="nota">Nota</option><option value="impuesto">Impuesto</option></select></div></div><div class="dynamic-fields-container" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem"></div><div class="price-section" style="border-top:1px solid var(--color-secundario);margin-top:1rem;padding-top:1rem"><div class="price-details-container"><div class="form-group"><label for="precio-persona-${uniqueId}">Precio p/p</label><input type="number" id="precio-persona-${uniqueId}" class="item-price-per-person" min="0" value="0"></div><div class="total-display"><strong>TOTAL:</strong> <span class="total-amount">0</span></div></div></div><button class="btn btn-secondary export-pago-btn" style="margin-top:1rem;width:100%">Exportar Pago (JSON)</button></div></div>`;
        }
        
        function createFieldElement(fieldName, cardId) {
            const fieldId = `${fieldName}-${cardId}`;
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            formGroup.dataset.fieldName = fieldName;
            const deleteButton = `<button type="button" class="btn-delete-field" aria-label="Eliminar campo"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>`;

            let labelText = '';
            let inputElement;

            switch (fieldName) {
                case 'aerolinea':
                    formGroup.style.gridColumn = '1 / -1';
                    const airlineSelect = document.createElement('select');
                    airlineSelect.id = `${fieldId}-selector`;
                    airlineSelect.className = 'airline-selector';
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Seleccione una aerolínea...';
                    airlineSelect.appendChild(defaultOption);
                    Object.keys(airlinesData).forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        airlineSelect.appendChild(option);
                    });
                    const infoDisplay = document.createElement('p');
                    infoDisplay.id = `${fieldId}-info`;
                    infoDisplay.className = 'airline-info-display';
                    infoDisplay.style.cssText = 'margin-top: 0.5rem; background-color: var(--color-secundario); padding: 0.8rem; border-radius: 8px; min-height: 40px; color: var(--color-texto); font-size: 0.9rem;';

                    const airlineFieldsContainer = document.createElement('div');
                    airlineFieldsContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;';
                    
                    const fields = ['boleto-ida', 'boleto-vuelta', 'precio-asiento', 'equipaje-basico', 'equipaje-medio', 'equipaje-full', 'precio-opcional'];
                    fields.forEach(f => {
                        const subGroup = document.createElement('div');
                        subGroup.className = 'form-group';
                        const subLabel = document.createElement('label');
                        subLabel.setAttribute('for', `${fieldId}-${f}`);
                        subLabel.textContent = f.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                        const subInput = document.createElement('input');
                        subInput.type = 'number';
                        subInput.id = `${fieldId}-${f}`;
                        subInput.className = 'airline-price';
                        subInput.value = '0';
                        subInput.min = '0';
                        subGroup.append(subLabel, subInput);
                        airlineFieldsContainer.appendChild(subGroup);
                    });

                    formGroup.innerHTML = `<label for="${fieldId}-selector">Aerolínea</label>`;
                    formGroup.appendChild(airlineSelect);
                    formGroup.innerHTML += deleteButton;
                    formGroup.appendChild(infoDisplay);
                    formGroup.appendChild(airlineFieldsContainer);

                    airlineSelect.addEventListener('change', (e) => {
                        const selectedAirline = e.target.value;
                        infoDisplay.textContent = airlinesData[selectedAirline] || '';
                        updateTotals(e.target);
                    });
                    return formGroup;

                case 'descripcion': labelText = 'Descripción'; inputElement = document.createElement('input'); inputElement.type = 'text'; break;
                case 'telefono': labelText = 'Teléfono'; inputElement = document.createElement('input'); inputElement.type = 'tel'; inputElement.maxLength = 8; inputElement.className = 'phone-input'; break;
                case 'whatsapp': labelText = 'WhatsApp'; inputElement = document.createElement('input'); inputElement.type = 'tel'; inputElement.maxLength = 8; inputElement.className = 'phone-input'; break;
                case 'email': labelText = 'Email'; inputElement = document.createElement('input'); inputElement.type = 'email'; break;
                case 'fecha': labelText = 'Fecha'; inputElement = document.createElement('input'); inputElement.type = 'date'; break;
                case 'cantidad': labelText = 'Cantidad'; inputElement = document.createElement('input'); inputElement.type = 'number'; inputElement.value = '1'; inputElement.min = '1'; inputElement.className = 'item-quantity'; break;
                case 'tipo_pago':
                    labelText = 'Tipo de Pago';
                    inputElement = document.createElement('select');
                    ['Efectivo', 'SINPE', 'Transferencia'].forEach(op => {
                        const option = document.createElement('option');
                        option.value = op.toLowerCase();
                        option.textContent = op;
                        inputElement.appendChild(option);
                    });
                    break;
                case 'guias': labelText = 'Guías'; inputElement = document.createElement('input'); inputElement.type = 'text'; break;
                case 'nombre_encargado': labelText = 'Nombre Encargado'; inputElement = document.createElement('input'); inputElement.type = 'text'; break;
                case 'telefono_encargado': labelText = 'Teléfono Encargado'; inputElement = document.createElement('input'); inputElement.type = 'tel'; inputElement.maxLength = 8; inputElement.className = 'phone-input'; break;
                case 'nota': labelText = 'Nota'; inputElement = document.createElement('textarea'); inputElement.rows = 3; break;
                case 'impuesto':
                    labelText = 'Impuesto';
                    inputElement = document.createElement('select');
                    ['No', 'Sí'].forEach(op => {
                        const option = document.createElement('option');
                        option.value = op.toLowerCase();
                        option.textContent = op;
                        inputElement.appendChild(option);
                    });
                    inputElement.className = 'impuesto-selector';
                    
                    const montoContainer = document.createElement('div');
                    montoContainer.className = 'form-group monto-impuesto-container';
                    montoContainer.style.cssText = 'display: none; margin-top: 1rem; margin-bottom: 0;';
                    const montoLabel = document.createElement('label');
                    montoLabel.setAttribute('for', `monto-${fieldId}`);
                    montoLabel.textContent = 'Monto Impuesto';
                    const montoInput = document.createElement('input');
                    montoInput.type = 'number';
                    montoInput.id = `monto-${fieldId}`;
                    montoInput.min = '0';
                    montoInput.value = '0';
                    montoContainer.append(montoLabel, montoInput);

                    formGroup.appendChild(document.createElement('label')).textContent = labelText;
                    formGroup.appendChild(inputElement);
                    formGroup.innerHTML += deleteButton; 
                    formGroup.appendChild(montoContainer);

                    inputElement.addEventListener('change', () => {
                        montoContainer.style.display = inputElement.value === 'si' ? 'block' : 'none';
                        updateTotals(inputElement);
                    });
                    return formGroup;
                default:
                    return null;
            }

            const label = document.createElement('label');
            label.setAttribute('for', fieldId);
            label.textContent = labelText;
            inputElement.id = fieldId;
            formGroup.append(label, inputElement);
            formGroup.innerHTML += deleteButton;

            return formGroup;
        }

        document.body.addEventListener('change', (e) => {
            const fieldSelector = e.target.matches('.field-selector');
            const impuestoSelector = e.target.matches('.impuesto-selector');
            const priceTypeSelector = e.target.matches('.price-type-selector');
            const airlineSelector = e.target.matches('.airline-selector');

            if (fieldSelector) {
                const select = e.target;
                const fieldName = select.value;
                const cardId = select.dataset.cardId;
                if (!fieldName || !cardId) return;
                const card = document.getElementById(cardId);
                if (card) {
                    const container = card.querySelector('.dynamic-fields-container');
                    const newFieldElement = createFieldElement(fieldName, cardId);
                    if (newFieldElement) {
                        container.appendChild(newFieldElement);
                        const optionToDisable = select.querySelector(`option[value="${fieldName}"]`);
                        if (optionToDisable) optionToDisable.disabled = true;
                        select.value = '';
                        if (fieldName === 'aerolinea') {
                            togglePriceVisibility(card);
                        }
                        updateTotals(card.querySelector('input'));
                    }
                }
            }
            if (impuestoSelector) {
                const montoContainer = e.target.closest('.form-group').querySelector('.monto-impuesto-container');
                if (montoContainer) montoContainer.style.display = e.target.value === 'si' ? 'block' : 'none';
            }
            if (priceTypeSelector) {
                updatePriceFields(e.target);
            }
            if (airlineSelector) {
                const selectedAirline = e.target.value;
                const infoDisplay = e.target.closest('.form-group').querySelector('.airline-info-display');
                if (infoDisplay) {
                    infoDisplay.textContent = airlinesData[selectedAirline] || '';
                }
            }
        });

        document.body.addEventListener('input', (e) => {
            const card = e.target.closest('.item-card');
            if (card) {
                updateTotals(e.target);
            } else {
                calculateGrandTotal('transporte-nacional-list');
            }
        });
        
        const globalCalculationFields = [eventoPrecio, eventoCapacidadCG, eventoCapacidadSG, tipoCambioInput];
        globalCalculationFields.forEach(field => {
            if (field) field.addEventListener('input', () => {
                updateAllTotals();
            });
        });

        function updatePriceFields(selectElement, shouldUpdateTotals = true) {
            const itemCard = selectElement.closest('.item-card');
            const priceSection = itemCard.querySelector('.price-section');
            const uniqueId = itemCard.id;
            const currencySymbol = currentCurrency === 'CRC' ? '₡' : '$';
            if (selectElement.value === 'persona') {
                priceSection.innerHTML = `<div class="price-details-container"><div class="form-group"><label for="precio-persona-${uniqueId}">Precio p/p</label><input type="number" id="precio-persona-${uniqueId}" class="item-price-per-person" min="0" value="0"></div><div class="total-display"><strong>TOTAL:</strong> <span class="total-amount">${currencySymbol}0</span></div></div>`;
            } else {
                priceSection.innerHTML = `<div class="price-details-container"><div class="form-group"><label for="precio-grupal-${uniqueId}">Precio Grupal</label><input type="number" id="precio-grupal-${uniqueId}" class="item-price-grupal" min="0" value="0"></div><div class="grupal-total-formula"><strong>TOTAL:</strong> <span class="grupal-amount">${currencySymbol}0</span></div></div>`;
            }
            togglePriceVisibility(itemCard);
            if (shouldUpdateTotals) {
                updateTotals(selectElement);
            }
        }
        
        function calculateBaseTotal(card, type) {
            const capacidadCG = parseFloat(eventoCapacidadCG?.value) || 0;
            const capacidadSG = parseFloat(eventoCapacidadSG?.value) || 0;
            const airlineField = card.querySelector('[data-field-name="aerolinea"]');

            if (capacidadSG === 0) return 0;

            if (airlineField) {
                let totalAerolineaCalculado = 0;
                card.querySelectorAll('.airline-price').forEach(input => {
                    totalAerolineaCalculado += parseFloat(input.value) || 0;
                });
                return totalAerolineaCalculado * capacidadCG / capacidadSG;
            }
            
            let precio = 0;
            if (type === 'persona') {
                precio = parseFloat(card.querySelector('.item-price-per-person')?.value) || 0;
                return precio * capacidadCG / capacidadSG;
            } else { 
                precio = parseFloat(card.querySelector('.item-price-grupal')?.value) || 0;
                return precio / capacidadSG;
            }
        }

        function formatCurrency(amount,currency=currentCurrency){const symbol=currency==='CRC'?'₡':'$';const value=Math.round(amount);return`${symbol}${value.toLocaleString('es-CR')}`;}

        function updateTotals(element) {
            const card = element.closest('.item-card');
            if (!card) return;

            togglePriceVisibility(card); 

            const priceType = card.querySelector('.price-type-selector').value;
            const baseTotal = calculateBaseTotal(card, priceType);
            const cantidadInput = card.querySelector('.item-quantity');
            
            const totalDisplay = card.querySelector('.total-display, .grupal-total-formula');
            const totalSpan = card.querySelector('.total-amount, .grupal-amount');
            
            let finalTotal = baseTotal;
            let label = "TOTAL:";

            if (cantidadInput) {
                const cantidad = parseFloat(cantidadInput.value) || 1;
                finalTotal = baseTotal * cantidad;
                label = "TOTAL X CANTIDAD:";
            }

            if(totalDisplay && totalSpan) {
                totalDisplay.querySelector('strong').textContent = label;
                totalSpan.textContent = formatCurrency(finalTotal);
            }
            
            const summaryContainer = card.querySelector('.collapsed-summary');
            if (summaryContainer) {
                const nombre = card.querySelector('.item-nombre').value || 'Sin Nombre';
                summaryContainer.innerHTML = `<div class="total-display"><strong>${label}</strong> ${formatCurrency(finalTotal)}</div><h4>${nombre}</h4>`;
            }
            
            const category = card.parentElement.id;
            calculateGrandTotal(category);
        }

        function calculateGrandTotal(category){
            if(!category)return;
            const list=document.getElementById(category);
            const categoryName='nacionales';
            const totalContainer=document.getElementById(`grand-total-${categoryName}`);
            const diferenciaContainer=document.getElementById(`diferencia-${categoryName}`);
            const diferenciaGeneralContainer=document.getElementById(`diferencia-general-${categoryName}`);
            
            const totalRecogerContainer = document.getElementById('total-por-recoger');
            const totalRecogerCrcContainer = document.getElementById('total-por-recoger-crc');
            const totalRecogerCrcWrapper = document.getElementById('total-por-recoger-crc-wrapper');

            if (!list || !totalContainer || !diferenciaContainer || !diferenciaGeneralContainer) return;

            let grandTotal = 0;
            list.querySelectorAll('.item-card').forEach(card => {
                const baseTotal = calculateBaseTotal(card, card.querySelector('.price-type-selector').value);
                const cantidadInput = card.querySelector('.item-quantity');
                grandTotal += (cantidadInput) ? (baseTotal * (parseFloat(cantidadInput.value) || 1)) : baseTotal;
            });

            const precioDelEvento = parseFloat(eventoPrecio.value) || 0;
            const capacidadCG = parseFloat(eventoCapacidadCG.value) || 0;
            const capacidadSG = parseFloat(eventoCapacidadSG.value) || 0; 
            
            const totalPorRecoger = precioDelEvento * capacidadSG;

            const diferencia = precioDelEvento - grandTotal;
            const diferenciaGeneral = diferencia * capacidadSG;

            if (totalRecogerContainer) {
                totalRecogerContainer.textContent = formatCurrency(totalPorRecoger);
            }

            totalContainer.textContent = formatCurrency(grandTotal);
            diferenciaContainer.textContent = formatCurrency(diferencia);
            diferenciaGeneralContainer.textContent = formatCurrency(diferenciaGeneral);

            diferenciaContainer.classList.toggle('text-danger', diferencia < 0);
            diferenciaGeneralContainer.classList.toggle('text-danger', diferenciaGeneral < 0);

            const tipoCambio = parseFloat(tipoCambioInput.value) || 1;
            if (currentCurrency === 'USD') {
                totalConversionDisplay.textContent = formatCurrency(precioDelEvento * tipoCambio, 'CRC');
                grandTotalNacionalesCrc.textContent = formatCurrency(grandTotal * tipoCambio, 'CRC');
                diferenciaNacionalesCrc.textContent = formatCurrency(diferencia * tipoCambio, 'CRC');
                diferenciaGeneralNacionalesCrc.textContent = formatCurrency(diferenciaGeneral * tipoCambio, 'CRC');
                
                if (totalRecogerCrcContainer) {
                    totalRecogerCrcContainer.textContent = formatCurrency(totalPorRecoger * tipoCambio, 'CRC');
                }
                if (totalRecogerCrcWrapper) totalRecogerCrcWrapper.style.display = 'block';
                
                diferenciaNacionalesCrc.parentElement.classList.toggle('text-danger', diferencia * tipoCambio < 0);
                diferenciaGeneralNacionalesCrc.parentElement.classList.toggle('text-danger', diferenciaGeneral * tipoCambio < 0);

                crcConversionWrappers.forEach(wrapper => {
                    if(wrapper.id !== 'total-por-recoger-crc-wrapper') wrapper.style.display = 'block';
                });
            } else { 
                totalConversionDisplay.textContent = formatCurrency(precioDelEvento / tipoCambio, 'USD');
                crcConversionWrappers.forEach(wrapper => wrapper.style.display = 'none');
                if (totalRecogerCrcWrapper) totalRecogerCrcWrapper.style.display = 'none';
            }
            
            if (diferenciaGeneral < 0) {
                showLossWarningModal();
            }
        }

        function updateAllTotals() {
            document.querySelectorAll('.item-card').forEach(card => {
                updateTotals(card.querySelector('input'));
            });
            calculateGrandTotal('transporte-nacional-list');
        }
        
        const notificationModal = document.getElementById('notification-modal');
        function showNotification(message) {
            notificationModal.querySelector('#notification-message').textContent = message;
            notificationModal.classList.add('visible');
        }
        notificationModal.querySelector('#notification-accept-btn').addEventListener('click', () => notificationModal.classList.remove('visible'));

        function showLossWarningModal() {
            lossWarningModal.classList.add('visible');
        }
        lossWarningCloseBtn.addEventListener('click', () => lossWarningModal.classList.remove('visible'));

        let deleteAction = null; 
        let addAction = null;

        function openDeleteModal(message, onConfirm) {
            deleteConfirmMessage.textContent = message;
            deleteAction = onConfirm;
            deleteConfirmModal.classList.add('visible');
        }

        function closeDeleteModal() {
            deleteConfirmModal.classList.remove('visible');
            deleteAction = null;
        }

        deleteCancelBtn.addEventListener('click', closeDeleteModal);
        deleteConfirmBtn.addEventListener('click', () => {
            if (deleteAction) {
                deleteAction();
            }
            closeDeleteModal();
        });

        function openAddModal(onConfirm) {
            addAction = onConfirm;
            addConfirmModal.classList.add('visible');
        }

        function closeAddModal() {
            addConfirmModal.classList.remove('visible');
            addAction = null;
        }
        addCancelBtn.addEventListener('click', closeAddModal);
        addConfirmBtn.addEventListener('click', () => {
            if (addAction) {
                addAction();
            }
            closeAddModal();
        });

        facturaCloseBtn.addEventListener('click', () => {
            facturaModal.classList.remove('visible');
        });

        facturaPrintBtn.addEventListener('click', () => {
            printFactura();
        });

        // Generador SVG -> Canvas para reemplazar Html2Canvas sin CDNs
        function generateCanvasFromFactura(callback) {
            const element = document.getElementById('factura-print-content');
            
            let styleText = "";
            for (let i = 0; i < document.styleSheets.length; i++) {
                try {
                    const sheet = document.styleSheets[i];
                    for (let j = 0; j < sheet.cssRules.length; j++) {
                        styleText += sheet.cssRules[j].cssText;
                    }
                } catch(e) {}
            }

            const width = element.offsetWidth;
            const height = element.offsetHeight;
            const xmlSerializer = new XMLSerializer();
            const elementHtml = xmlSerializer.serializeToString(element);
            
            const svgString = `
                <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
                    <foreignObject width="100%" height="100%">
                        <div xmlns="http://www.w3.org/1999/xhtml" style="width: ${width}px; height: ${height}px;">
                            <style>${styleText}</style>
                            ${elementHtml}
                        </div>
                    </foreignObject>
                </svg>
            `;

            const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(svgBlob);
            const img = new Image();
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const scale = 2; 
                canvas.width = width * scale;
                canvas.height = height * scale;
                const ctx = canvas.getContext('2d');
                ctx.scale(scale, scale);
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);
                ctx.drawImage(img, 0, 0);
                
                URL.revokeObjectURL(url);
                callback(canvas);
            };
            
            img.onerror = () => {
                console.error('Error al renderizar el SVG interno');
                showNotification('Error visual al generar imagen. Se recomienda imprimir a PDF.');
            };
            
            img.src = url;
        }

        facturaPdfBtn.addEventListener('click', () => {
            generateCanvasFromFactura((canvas) => {
                const link = document.createElement('a');
                link.download = `factura-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showNotification('Factura exportada como imagen exitosamente');
            });
        });

        facturaWhatsappBtn.addEventListener('click', () => {
            const title = document.getElementById('factura-title').textContent;
            generateCanvasFromFactura((canvas) => {
                canvas.toBlob(blob => {
                    const file = new File([blob], 'factura.png', { type: 'image/png' });
                    
                    if (navigator.share && navigator.canShare({ files: [file] })) {
                        navigator.share({
                            title: title,
                            text: `Te comparto la factura: ${title}`,
                            files: [file]
                        }).then(() => {
                            showNotification('Factura compartida exitosamente');
                        }).catch(error => {
                            console.error('Error al compartir:', error);
                            fallbackWhatsAppShare(canvas);
                        });
                    } else {
                        fallbackWhatsAppShare(canvas);
                    }
                });
            });
        });

        document.body.addEventListener('click', (e) => {
            if (e.target.closest('.btn-delete-item')) {
                const element = e.target.closest('.item-card');
                openDeleteModal('¿Estás seguro de que deseas borrar este pago?', () => {
                    const category = element.parentElement.id;
                    element.remove();
                    calculateGrandTotal(category);
                });
            }
        });

        function startEditConfirmation(id) {
            eventToLoadId = id;
            editConfirmCount = 0;
            showNextEditConfirmation();
        }

        function showFactura(id) {
            db.transaction(['eventos'], 'readonly').objectStore('eventos').get(id).onsuccess = (e) => {
                const evento = e.target.result;
                if (!evento) return;

                const fecha = new Date().toLocaleDateString('es-CR');
                const hora = new Date().toLocaleTimeString('es-CR');
                
                let facturaHTML = `
                    <div id="factura-print-content" style="border: 2px solid var(--color-secundario); padding: 2rem; background: var(--color-blanco);">
                        <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid var(--color-primario); padding-bottom: 1rem;">
                            <h2 style="margin: 0; color: var(--color-primario); font-size: 2rem;">FACTURA</h2>
                            <p style="margin: 0.5rem 0; color: var(--color-texto);">Comprobante de Pagos del Evento</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-primario);">Datos del Evento</h4>
                                <p style="margin: 0.25rem 0;"><strong>Nombre:</strong> ${evento.nombre}</p>
                                <p style="margin: 0.25rem 0;"><strong>Precio Base:</strong> ${formatCurrency(parseFloat(evento.precio) || 0, evento.moneda)}</p>
                                <p style="margin: 0.25rem 0;"><strong>Capacidad C/G:</strong> ${evento.capacidadCG}</p>
                                <p style="margin: 0.25rem 0;"><strong>Capacidad S/G:</strong> ${evento.capacidadSG}</p>
                                <p style="margin: 0.25rem 0;"><strong>Moneda:</strong> ${evento.moneda}</p>
                                ${evento.moneda === 'USD' ? `<p style="margin: 0.25rem 0;"><strong>Tipo Cambio:</strong> ${evento.tipoCambio}</p>` : ''}
                            </div>
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-primario);">Datos de Facturación</h4>
                                <p style="margin: 0.25rem 0;"><strong>Número:</strong> FAC-${String(id).padStart(6, '0')}</p>
                                <p style="margin: 0.25rem 0;"><strong>Fecha:</strong> ${fecha}</p>
                                <p style="margin: 0.25rem 0;"><strong>Hora:</strong> ${hora}</p>
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin: 0 0 1rem 0; color: var(--color-primario); border-bottom: 1px solid var(--color-secundario); padding-bottom: 0.5rem;">Detalle de Pagos</h4>
                `;

                if (!evento.pagos || evento.pagos.length === 0) {
                    facturaHTML += `
                        <p style="text-align: center; color: var(--color-texto); padding: 2rem;">No hay pagos registrados para este evento.</p>
                    `;
                } else {
                    facturaHTML += `
                        <table class="factura-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--color-secundario);">
                                    <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--color-secundario);">#</th>
                                    <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--color-secundario);">Nombre</th>
                                    <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--color-secundario);">Tipo</th>
                                    <th style="padding: 0.75rem; text-align: right; border: 1px solid var(--color-secundario);">Precio Unitario</th>
                                    <th style="padding: 0.75rem; text-align: right; border: 1px solid var(--color-secundario);">Cantidad</th>
                                    <th style="padding: 0.75rem; text-align: right; border: 1px solid var(--color-secundario);">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    facturaHTML += `
                        <div class="factura-mobile-list" style="display: none;">
                    `;

                    let granTotal = 0;
                    const capacidadCG = parseFloat(evento.capacidadCG) || 0;
                    const capacidadSG = parseFloat(evento.capacidadSG) || 1;

                    evento.pagos.forEach((pago, index) => {
                        let precioUnitario = 0;
                        
                        if (pago.tipoPrecio === 'persona') {
                            precioUnitario = (parseFloat(pago.precioPersona) || 0) * capacidadCG / capacidadSG;
                        } else {
                            precioUnitario = (parseFloat(pago.precioGrupal) || 0) / capacidadSG;
                        }

                        const cantidad = (pago.dynamicFields && pago.dynamicFields.cantidad) ? parseFloat(pago.dynamicFields.cantidad) : 1;
                        const total = precioUnitario * cantidad;
                        granTotal += total;

                        facturaHTML += `
                            <tr>
                                <td style="padding: 0.75rem; text-align: left; border: 1px solid var(--color-secundario);">${index + 1}</td>
                                <td style="padding: 0.75rem; text-align: left; border: 1px solid var(--color-secundario);">${pago.nombre}</td>
                                <td style="padding: 0.75rem; text-align: left; border: 1px solid var(--color-secundario);">${pago.tipoPrecio === 'persona' ? 'Persona' : 'Grupal'}</td>
                                <td style="padding: 0.75rem; text-align: right; border: 1px solid var(--color-secundario);">${formatCurrency(precioUnitario, evento.moneda)}</td>
                                <td style="padding: 0.75rem; text-align: right; border: 1px solid var(--color-secundario);">${cantidad}</td>
                                <td style="padding: 0.75rem; text-align: right; border: 1px solid var(--color-secundario); font-weight: bold;">${formatCurrency(total, evento.moneda)}</td>
                            </tr>
                        `;

                        facturaHTML += `
                            <div class="factura-mobile-item">
                                <div class="factura-mobile-header">${index + 1}. ${pago.nombre}</div>
                                <div class="factura-mobile-details">
                                    <div class="factura-mobile-detail">
                                        <strong>Tipo:</strong>
                                        <span>${pago.tipoPrecio === 'persona' ? 'Persona' : 'Grupal'}</span>
                                    </div>
                                    <div class="factura-mobile-detail">
                                        <strong>Precio Unitario:</strong>
                                        <span>${formatCurrency(precioUnitario, evento.moneda)}</span>
                                    </div>
                                    <div class="factura-mobile-detail">
                                        <strong>Cantidad:</strong>
                                        <span>${cantidad}</span>
                                    </div>
                                </div>
                                <div class="factura-mobile-total">
                                    Total: ${formatCurrency(total, evento.moneda)}
                                </div>
                            </div>
                        `;
                    });

                    const precioBase = parseFloat(evento.precio) || 0;
                    const excedente = precioBase - granTotal;

                    facturaHTML += `
                            </tbody>
                            <tfoot>
                                <tr style="background: var(--color-primario); color: white;">
                                    <td colspan="5" style="padding: 0.75rem; text-align: right; border: 1px solid var(--color-primario); font-weight: bold;">GRAN TOTAL:</td>
                                    <td style="padding: 0.75rem; text-align: right; border: 1px solid var(--color-primario); font-weight: bold; font-size: 1.2rem;">${formatCurrency(granTotal, evento.moneda)}</td>
                                </tr>
                                <tr style="background: ${excedente < 0 ? 'var(--color-error)' : 'var(--color-exito)'}; color: white;">
                                    <td colspan="5" style="padding: 0.75rem; text-align: right; border: 1px solid transparent; font-weight: bold;">EXCEDENTE:</td>
                                    <td style="padding: 0.75rem; text-align: right; border: 1px solid transparent; font-weight: bold; font-size: 1.2rem;">${formatCurrency(excedente, evento.moneda)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    `;

                    facturaHTML += `
                        <div class="factura-mobile-item" style="background: var(--color-primario); color: white;">
                            <div class="factura-mobile-details">
                                <div class="factura-mobile-detail">
                                    <strong style="color: white;">GRAN TOTAL:</strong>
                                    <span style="color: white; font-weight: bold; font-size: 1.2rem;">${formatCurrency(granTotal, evento.moneda)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="factura-mobile-item" style="background: ${excedente < 0 ? 'var(--color-error)' : 'var(--color-exito)'}; color: white; margin-top: 0.5rem;">
                            <div class="factura-mobile-details">
                                <div class="factura-mobile-detail">
                                    <strong style="color: white;">EXCEDENTE:</strong>
                                    <span style="color: white; font-weight: bold; font-size: 1.2rem;">${formatCurrency(excedente, evento.moneda)}</span>
                                </div>
                            </div>
                        </div>
                        </div>
                    `;
                }

                facturaHTML += `
                        </div>
                        
                        <div style="margin-top: 3rem; text-align: center;">
                            <p style="margin: 0; color: var(--color-texto); font-size: 0.9rem;">Este documento es un comprobante generado automáticamente</p>
                            <p style="margin: 0.25rem 0 0 0; color: var(--color-texto); font-size: 0.9rem;">Sistema de Gestión de Pagos - Tabla de Pagos V2</p>
                        </div>
                    </div>
                `;

                facturaTitle.textContent = `FACTURA - ${evento.nombre}`;
                facturaContent.innerHTML = facturaHTML;
                facturaModal.classList.add('visible');
            };
        }

        function printFactura() {
            const printContent = document.getElementById('factura-print-content').cloneNode(true);
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Factura</title>
                    <style>
                        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    ${printContent.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        function fallbackWhatsAppShare(canvas) {
            const dataUrl = canvas.toDataURL('image/png');
            const title = document.getElementById('factura-title').textContent;
            const text = `Te comparto la factura: ${title}`;
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: text,
                    url: dataUrl
                }).then(() => {
                    showNotification('Enlace compartido exitosamente');
                }).catch(error => {
                    console.error('Error al compartir:', error);
                    copyToClipboard(dataUrl);
                });
            } else {
                copyToClipboard(dataUrl);
            }
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showNotification('Factura copiada al portapapeles. Pégala en WhatsApp.');
            } catch (error) {
                console.error('Error al copiar:', error);
                showNotification('No se pudo copiar. Intenta guardar como imagen manualmente.');
            }
            
            document.body.removeChild(textarea);
        }

        function showNextEditConfirmation() {
            editConfirmCount++;
            if (editConfirmCount > 3) {
                editConfirmModal.classList.remove('visible');
                loadEventData(eventToLoadId);
                return;
            }
            editConfirmMessage.textContent = `Confirmación ${editConfirmCount} de 3. ¿Realmente deseas editar este evento?`;
            editConfirmModal.classList.add('visible');
        }

        editConfirmBtn.addEventListener('click', showNextEditConfirmation);
        editCancelBtn.addEventListener('click', () => {
            editConfirmModal.classList.remove('visible');
            editConfirmCount = 0;
            eventToLoadId = null;
        });

        function applyTheme(theme) {
            document.body.className = theme;
            localStorage.setItem('theme', theme);
            const themeColor = getComputedStyle(document.body).getPropertyValue('--color-primario').trim();
            document.querySelector('meta[name="theme-color"]').setAttribute('content', themeColor);
        }

        // Asignación de botones de tema
        document.getElementById('btn-theme-light').addEventListener('click', () => applyTheme('theme-light'));
        document.getElementById('btn-theme-dark').addEventListener('click', () => applyTheme('theme-dark'));
        
        nuevoEventoBtn.addEventListener('click', () => {
            currentEventId = null;
            eventoNombre.value = '';
            eventoPrecio.value = '0';
            eventoCapacidadCG.value = '0';
            eventoCapacidadSG.value = '0';
            document.getElementById('transporte-nacional-list').innerHTML = '';
            updateAllTotals();
            showNotification('Formulario limpiado. Listo para un nuevo evento.');
        });

        function getPagoDataFromCard(card) {
            const pago = {
                nombre: card.querySelector('.item-nombre').value,
                tipoPrecio: card.querySelector('.price-type-selector').value,
                precioPersona: card.querySelector('.item-price-per-person')?.value || '0',
                precioGrupal: card.querySelector('.item-price-grupal')?.value || '0',
                dynamicFields: {}
            };

            card.querySelectorAll('.dynamic-fields-container > .form-group').forEach(group => {
                const fieldName = group.dataset.fieldName;
                if (!fieldName) return;

                if (fieldName === 'aerolinea') {
                    const airlineData = { nombre: group.querySelector('.airline-selector')?.value || '' };
                    group.querySelectorAll('.airline-price').forEach(priceInput => {
                        const key = priceInput.id.replace(`aerolinea-${card.id}-`, '').replace(/-/g, '_');
                        airlineData[key] = priceInput.value;
                    });
                    pago.dynamicFields.aerolinea = airlineData;
                } else if (fieldName === 'impuesto') {
                    pago.dynamicFields.impuesto = {
                        aplica: group.querySelector('.impuesto-selector').value,
                        monto: group.querySelector('.monto-impuesto-container input')?.value || '0'
                    };
                } else {
                    const input = group.querySelector('input, select, textarea');
                    if (input) pago.dynamicFields[fieldName] = input.value;
                }
            });
            return pago;
        }

        guardarEventoBtn.addEventListener('click', () => {
            const nombre = eventoNombre.value.trim();
            if (!nombre) {
                showNotification('Por favor, ingresa un nombre para el evento antes de guardar.');
                return;
            }

            const pagos = [];
            document.querySelectorAll('#transporte-nacional-list .item-card').forEach(card => {
                pagos.push(getPagoDataFromCard(card));
            });

            const evento = {
                nombre,
                precio: eventoPrecio.value,
                capacidadCG: eventoCapacidadCG.value,
                capacidadSG: eventoCapacidadSG.value,
                tipoCambio: tipoCambioInput.value,
                moneda: currentCurrency,
                pagos
            };

            const transaction = db.transaction(['eventos'], 'readwrite');
            const store = transaction.objectStore('eventos');
            if (currentEventId) evento.id = currentEventId;

            const request = currentEventId ? store.put(evento) : store.add(evento);

            request.onsuccess = () => {
                showNotification(`Evento "${nombre}" guardado exitosamente.`);
                loadEvents();
                if (!currentEventId) currentEventId = request.result;
            };
            request.onerror = (e) => {
                showNotification('Error al guardar el evento.');
                console.error('Error al guardar:', e.target.error);
            };
        });

        function deleteEvent(id) {
            openDeleteModal('¿Estás seguro de que deseas eliminar este evento guardado?', () => {
                const transaction = db.transaction(['eventos'], 'readwrite');
                transaction.objectStore('eventos').delete(id).onsuccess = () => {
                    showNotification('Evento eliminado.');
                    loadEvents(); 
                };
            });
        }

        function renderEventsList(eventsToRender) {
            eventosGuardadosList.innerHTML = '';
            
            if (eventsToRender.length === 0) {
                eventosGuardadosList.innerHTML = '<p style="color:var(--color-texto); width:100%; text-align:center;">No se encontraron eventos.</p>';
                return;
            }

            eventsToRender.forEach(evento => {
                const btn = document.createElement('button');
                btn.className = 'evento-guardado-btn';
                btn.dataset.eventId = evento.id;
                
                let grandTotal = 0;
                const capacidadCG = parseFloat(evento.capacidadCG) || 0;
                const capacidadSG = parseFloat(evento.capacidadSG) || 1;
                if (evento.pagos) {
                    evento.pagos.forEach(pago => {
                        let baseTotal = 0;
                        if (pago.tipoPrecio === 'persona') {
                            baseTotal = (parseFloat(pago.precioPersona) || 0) * capacidadCG / capacidadSG;
                        } else {
                            baseTotal = (parseFloat(pago.precioGrupal) || 0) / capacidadSG;
                        }
                        const cantidad = (pago.dynamicFields && pago.dynamicFields.cantidad) ? parseFloat(pago.dynamicFields.cantidad) : 1;
                        grandTotal += baseTotal * cantidad;
                    });
                }

                btn.innerHTML = `
                    <div>
                        <strong>${evento.nombre}</strong>
                        <small>TOTAL P/P: ${formatCurrency(grandTotal, evento.moneda)}</small>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-factura-evento" data-event-id="${evento.id}" aria-label="Ver Factura">
                            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zm-5.5-8.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zM6 15l3-3.86L11.5 14l2.5-3.21L18 15H6z"/></svg>
                        </button>
                        <button class="btn-delete-evento" data-event-id="${evento.id}" aria-label="Eliminar Evento">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>`;
                
                btn.addEventListener('click', (e) => {
                    if (e.target.closest('.btn-delete-evento')) {
                        e.stopPropagation();
                        deleteEvent(evento.id);
                    } else if (e.target.closest('.btn-factura-evento')) {
                        e.stopPropagation();
                        showFactura(evento.id);
                    } else {
                        startEditConfirmation(evento.id);
                    }
                });
                eventosGuardadosList.appendChild(btn);
            });
        }

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                eventosGuardadosWrapper.style.display = 'none';
                toggleEventosListBtn.textContent = 'Mostrar Lista';
                return;
            }

            const filteredEvents = allEventsCache.filter(evento => {
                const nombreMatch = evento.nombre.toLowerCase().includes(searchTerm);
                let grandTotal = 0;
                const capacidadCG = parseFloat(evento.capacidadCG) || 0;
                const capacidadSG = parseFloat(evento.capacidadSG) || 1;
                if (evento.pagos) {
                    evento.pagos.forEach(pago => {
                        let baseTotal = 0;
                        if (pago.tipoPrecio === 'persona') {
                            baseTotal = (parseFloat(pago.precioPersona) || 0) * capacidadCG / capacidadSG;
                        } else {
                            baseTotal = (parseFloat(pago.precioGrupal) || 0) / capacidadSG;
                        }
                        const cantidad = (pago.dynamicFields && pago.dynamicFields.cantidad) ? parseFloat(pago.dynamicFields.cantidad) : 1;
                        grandTotal += baseTotal * cantidad;
                    });
                }
                const precioMatch = grandTotal.toString().includes(searchTerm);
                
                return nombreMatch || precioMatch;
            });

            renderEventsList(filteredEvents);
            eventosGuardadosWrapper.style.display = 'block';
            toggleEventosListBtn.textContent = 'Ocultar Lista';
        });

        toggleEventosListBtn.addEventListener('click', () => {
            if (eventosGuardadosWrapper.style.display === 'none') {
                renderEventsList(allEventsCache);
                eventosGuardadosWrapper.style.display = 'block';
                toggleEventosListBtn.textContent = 'Ocultar Lista';
            } else {
                eventosGuardadosWrapper.style.display = 'none';
                toggleEventosListBtn.textContent = 'Mostrar Lista';
            }
        });

        function loadEvents() {
            const store = db.transaction(['eventos'], 'readonly').objectStore('eventos');
            store.getAll().onsuccess = (e) => {
                allEventsCache = e.target.result; 
                eventosGuardadosWrapper.style.display = 'none';
                toggleEventosListBtn.textContent = 'Mostrar Lista';
                searchInput.value = ''; 
            };
        }

        function loadEventData(id) {
            db.transaction(['eventos'], 'readonly').objectStore('eventos').get(id).onsuccess = (e) => {
                const evento = e.target.result;
                if (!evento) return;

                currentEventId = evento.id;
                eventoNombre.value = evento.nombre;
                eventoPrecio.value = evento.precio;
                eventoCapacidadCG.value = evento.capacidadCG;
                eventoCapacidadSG.value = evento.capacidadSG;
                tipoCambioInput.value = evento.tipoCambio;
                currencySelector.value = evento.moneda;
                currencySelector.dispatchEvent(new Event('change'));

                const pagosList = document.getElementById('transporte-nacional-list');
                pagosList.innerHTML = '';

                if (evento.pagos) {
                    evento.pagos.forEach(pago => {
                        const cardWrapper = document.createElement('div');
                        cardWrapper.innerHTML = createItemHTML();
                        const cardElement = cardWrapper.firstElementChild;
                        
                        cardElement.querySelector('.item-nombre').value = pago.nombre;
                        const priceSelector = cardElement.querySelector('.price-type-selector');
                        priceSelector.value = pago.tipoPrecio;
                        updatePriceFields(priceSelector, false);

                        if (pago.tipoPrecio === 'persona') {
                            const priceInput = cardElement.querySelector('.item-price-per-person');
                            if(priceInput) priceInput.value = pago.precioPersona;
                        } else {
                            const priceInput = cardElement.querySelector('.item-price-grupal');
                            if(priceInput) priceInput.value = pago.precioGrupal;
                        }

                        const dynamicFieldsContainer = cardElement.querySelector('.dynamic-fields-container');
                        const fieldSelector = cardElement.querySelector('.field-selector');

                        if (pago.dynamicFields) {
                            for (const fieldName in pago.dynamicFields) {
                                if (!Object.prototype.hasOwnProperty.call(pago.dynamicFields, fieldName)) continue;
                                
                                const newFieldElement = createFieldElement(fieldName, cardElement.id);
                                if (newFieldElement) {
                                    dynamicFieldsContainer.appendChild(newFieldElement);
                                    
                                    const optionToDisable = fieldSelector.querySelector(`option[value="${fieldName}"]`);
                                    if (optionToDisable) optionToDisable.disabled = true;

                                    const fieldData = pago.dynamicFields[fieldName];

                                    if (fieldName === 'aerolinea') {
                                        const airlineSelector = newFieldElement.querySelector('.airline-selector');
                                        if (airlineSelector) {
                                            airlineSelector.value = fieldData.nombre || '';
                                            airlineSelector.dispatchEvent(new Event('change'));
                                        }
                                        for (const key in fieldData) {
                                            if (key !== 'nombre' && fieldData[key] !== null && fieldData[key] !== undefined) {
                                                const inputId = `#aerolinea-${cardElement.id}-${key.replace(/_/g, '-')}`;
                                                const priceInput = newFieldElement.querySelector(inputId);
                                                if (priceInput) priceInput.value = fieldData[key];
                                            }
                                        }
                                    } else if (fieldName === 'impuesto') {
                                        const selector = newFieldElement.querySelector('.impuesto-selector');
                                        const montoInput = newFieldElement.querySelector('.monto-impuesto-container input');
                                        if (selector) selector.value = fieldData.aplica;
                                        if (fieldData.aplica === 'si') {
                                            const montoContainer = newFieldElement.querySelector('.monto-impuesto-container');
                                            if(montoContainer) montoContainer.style.display = 'block';
                                            if(montoInput) montoInput.value = fieldData.monto;
                                        }
                                    } else {
                                        const input = newFieldElement.querySelector(`[id^="${fieldName}-"]`);
                                        if (input) input.value = fieldData;
                                    }
                                }
                            }
                        }
                        
                        pagosList.appendChild(cardElement);
                    });
                }
                updateAllTotals(); 
                showNotification(`Evento "${evento.nombre}" cargado.`);
            };
        }
        
        async function initializeApp() {
            applyTheme(localStorage.getItem('theme') || 'theme-light');
            await initDB();
            loadEvents();
            currencySelector.dispatchEvent(new Event('change'));
            checkAutosave();
            setInterval(updateAutosaveTimer, 1000);
        }

        initializeApp();

        function checkAutosave() {
            const lastBackupStr = localStorage.getItem('lastBackupTimestamp');
            if (!lastBackupStr) {
                localStorage.setItem('lastBackupTimestamp', Date.now().toString());
                return;
            }
            if (Date.now() - parseInt(lastBackupStr, 10) > AUTOSAVE_INTERVAL) {
                console.log("Realizando respaldo automático...");
                backupData(true);
            }
        }

        function updateAutosaveTimer() {
            const lastBackup = parseInt(localStorage.getItem('lastBackupTimestamp') || Date.now());
            const nextBackupTime = lastBackup + AUTOSAVE_INTERVAL;
            const remainingTime = nextBackupTime - Date.now();

            if (remainingTime <= 0) {
                autosaveTimerDisplay.textContent = 'Iniciando respaldo...';
                checkAutosave();
                return;
            }

            const d = Math.floor(remainingTime / (1000 * 60 * 60 * 24));
            const h = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((remainingTime % (1000 * 60)) / 1000);
            autosaveTimerDisplay.textContent = `${d}d ${h}h ${m}m ${s}s`;
        }

        function formatDateTime() {
            return new Date().toISOString().slice(0, 19).replace('T', '_').replace(/:/g, '-');
        }

        async function backupData(isAuto = false) {
            if (!db) {
                if (!isAuto) showNotification('La base de datos no está lista.');
                return;
            }
            db.transaction(['eventos'], 'readonly').objectStore('eventos').getAll().onsuccess = (e) => {
                const data = {
                    events: e.target.result
                };
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pagos_respaldo_${formatDateTime()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                localStorage.setItem('lastBackupTimestamp', Date.now().toString());
                if (!isAuto) showNotification('Respaldo completado exitosamente.');
            };
        }
        
        backupBtn.addEventListener('click', () => backupData(false));

        restoreInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const eventsToRestore = data.events || (Array.isArray(data) ? data : []);
                    if (!Array.isArray(eventsToRestore)) throw new Error("Formato de eventos no válido.");

                    const transaction = db.transaction(['eventos'], 'readwrite');
                    const store = transaction.objectStore('eventos');
                    store.clear(); 
                    eventsToRestore.forEach(item => { if (item.id) delete item.id; store.add(item); });

                    transaction.oncomplete = () => {
                        showNotification('Restauración completada. La página se recargará.');
                        setTimeout(() => window.location.reload(), 2000);
                    };
                } catch (error) {
                    showNotification(`Error al procesar el archivo: ${error.message}`);
                }
            };
            reader.readAsText(file);
            restoreInput.value = ''; 
        });
        
    });
    </script>
</body>
</html>